# What is this?

We had an old slackbot implementation, which synced discord messages to slack and vice versa. 
See https://github.com/cakephp/discord-slack-bridge

But this broke when Slack [changed their API](https://api.slack.com/changelog/2024-09-legacy-custom-bots-classic-apps-deprecation#legacy-custom-bots) 
and discontinued the RTM API. Therefore, it was time to replace it.

The current solution is to use [n8n](https://n8n.io/), a powerful workflow automation tool which can do so much more than just bridging Discord and Slack.


## Where is it set up?

It runs inside our [apps.cakephp.org](https://apps.cakephp.org) Server which hosts a bunch of dokku based apps.

The URL is https://automation.cakephp.org - for Backend access please ask a core member or [@lordsimal](https://github.com/LordSimal)


## How does it work?

## Slack => Discord Chat Sync

This uses the n8n built-in Slack trigger to listen for new messages in a specific Slack channel. 

Each channel needs to be mapped individually to a Discord channel, since we
- don't want to sync every channel and
- some channels may have different names in Slack and Discord

### Debugging Slack Messages with manual triggers in n8n

The Slack trigger can be a bit finicky, especially when testing. 
First a slack admin for the CakePHP Slack workspace needs to adjust the `Events URL` which is used by slack to send events to n8n.

In production mode, it is of course set to the production URL which is generated by n8n if you go into the workflow node settings and click on the `Webhook URLs` part at the top.

This production URL doesn't allow us to debug messages in n8n, so we need to put the `Test URL` into the `Events URL` field inside the Slack app settings.
After that, we can manually execute the workflow node, send a message, and see the output in the n8n UI.

Unfortunately, the Discord API doesn't allow us to send messages "as another users name" - aka make it appear as if the message was sent by the user who actually sent it in Slack.
It will always appear as `SlackBridge` which seems to be the name of the Slack app.

We can only prefix the message with the users name, so it is clear who sent the message in Slack.

### Problems to be fixed

- Files are not synced yet, only text messages.
- If a user edits or deletes a message in Slack, it is not synced to Discord.
- Reactions are not synced yet.
- Messages synced from Discord to Slack re-appear in discord again, since this slack message triggers the other workflow and therefore sends it back again. Aka - bot messages need to be excluded.
- Links sent from Slack to Discord appear as e.g.
```
https://book.cakephp.org/5/en/intro/conventions.html#database-conventions|https://book.cakephp.org/5/en/intro/conventions.html#database-conventions
```
- Slack messages seem to be HTML encoded, since they contain `slack =&gt; discord` instead of `slack => discord`


## Discord => Slack Chat Sync

This one was a bit more tricky, since Discord doesn't have a built-in trigger for new messages.

We needed to add a [community node](https://www.npmjs.com/package/n8n-nodes-discord-trigger) which adds a trigger for new messages in Discord channels.

This new bot also needed access to the [Gateway Intents](https://discord.com/developers/docs/events/gateway#gateway-intents) API, which was not present in the old bot we had till now.

Therefore, a new bot was created and was added to the CakePHP Discord server - very creatively named "CakePHP-Slack-Bot"

With that community node installed and the new bot added to the Discord server, we were now able to add a trigger for new messages in Discord channels.

### Problems to be fixed

- Files are not synced yet, only text messages.
- If a user edits or deletes a message in Discord, it is not synced to Slack.
- Reactions are not synced yet.


## Persisting community nodes in dokku 

At first there was a problem with the community node not being persisted in the Dokku app.
After a rebuild, the community node was not available anymore.

Fortunately, @d1ceward - who provided the initial Dokku setup - found a solution to this problem.
https://github.com/d1ceward-on-dokku/n8n_on_dokku/issues/4

```bash
dokku storage:ensure-directory automation --chown false
chown 1000:1000 /var/lib/dokku/data/storage/automation
dokku storage:mount automation /var/lib/dokku/data/storage/automation:/home/node/.n8n
```

With that, the community node is now persisted across rebuilds and restarts.

But I am not sure how to update community nodes yet...